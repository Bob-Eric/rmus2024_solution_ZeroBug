<?xml version="1.0"?>
<launch>
  <arg name="database_path" default="rtabmap.db" />

  <arg name="odometry" default="rgbd" doc="method type [rgbd, ekf, icp]" />
  <arg name="localization" default="false" />
  <arg name="simulation" default="false" />
  <arg if="$(arg localization)" name="args" default="" />
  <arg unless="$(arg localization)" name="args" default="-d" />


  <arg name="scan_topic" default="/rplidar/scan" />
  <arg name="rgb_topic" default="/camera/color/image_raw" />
  <arg name="depth_topic" default="/camera/aligned_depth_to_color/image_raw" />
  <arg name="camera_info_topic" default="/camera/color/camera_info" />
  <arg name="wait_for_transform" default="1.0" />

  <arg name="rviz" default="true" />
  <arg name="rviz_cfg" default="$(find rtab_slam)/rviz/rtab.rviz" />

  <!-- robot_description -->
  <include file="$(find ep_description)/launch/ep_description.launch" />


  <group ns="rtabmap">
    <!-- Use RGBD synchronization -->
    <node pkg="nodelet" type="nodelet" name="rgbd_sync" args="standalone rtabmap_sync/rgbd_sync"
      output="screen">
      <remap from="rgb/image" to="$(arg rgb_topic)" />
      <remap from="depth/image" to="$(arg depth_topic)" />
      <remap from="rgb/camera_info" to="$(arg camera_info_topic)" />
      <!-- output -->
      <remap from="rgbd_image" to="rgbd_image" />
      <!-- Should be true for not synchronized camera topics 
            (e.g., false for kinectv2, zed, realsense, true for xtion, kinect360)-->
      <param name="approx_sync" value="false" />
    </node>

    <!-- Mapping -->
    <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="$(arg args)">
      <param name="database_path" type="string" value="$(arg database_path)" />
      <param name="frame_id" type="string" value="base_link" />
      <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)" />


      <param name="subscribe_depth" type="bool" value="false" />
      <param name="subscribe_rgbd" type="bool" value="true" />
      <param name="subscribe_scan" type="bool" value="true" />
      <param name="map_negative_poses_ignored" type="bool" value="true" />

      <!-- When sending goals on /rtabmap/goal topic, use actionlib to communicate with move_base -->
      <param name="use_action_for_goal" type="bool" value="true" />
      <remap from="move_base" to="/move_base" />

      <!-- inputs -->
      <remap from="scan" to="$(arg scan_topic)" />
      <remap from="rgbd_image" to="rgbd_image" />
      <remap from="odom" to="odom" />

      <!-- output -->
      <!-- <remap from="grid_map" to="/map_kk" /> -->
      <!-- Used to extract more or less SURF features -->

      <param name="SURF/HessianThreshold" type="string" value="100" />
      <param name="RGBD/ProximityBySpace" type="string" value="true" />
      <param name="RGBD/OptimizeFromGraphEnd" type="string" value="false" />
      <param name="Kp/MaxDepth" type="string" value="4.0" />
      <param name="Reg/Strategy" type="string" value="0" />
      <param name="Icp/CorrespondenceRatio" type="string" value="0.3" />
      <param name="Vis/MinInliers" type="string" value="15" />
      <param name="Vis/InlierDistance" type="string" value="0.1" />
      <param name="RGBD/AngularUpdate" type="string" value="0.1" />
      <param name="RGBD/LinearUpdate" type="string" value="0.1" />
      <param name="RGBD/ProximityPathMaxNeighbors" type="string" value="0" />
      <param name="Rtabmap/TimeThr" type="string" value="0" />
      <param name="Mem/RehearsalSimilarity" type="string" value="0.30" />
      <param name="Reg/Force3DoF" type="string" value="true" />
      <param name="GridGlobal/MinSize" type="string" value="20" />

      <!-- localization mode -->
      <param if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false" />
      <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true" />
      <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)" />
    </node>

    <!-- Odometry : ONLY for testing without the actual robot! /odom TF should not be already
    published. -->
    <node if="$(eval 'rgbd' in arg('odometry'))" pkg="rtabmap_odom" type="rgbd_odometry"
      name="rgbd_odometry">
      <param name="frame_id" type="string" value="base_link" />
      <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)" />
      <param name="Vis/InlierDistance" type="string" value="0.05" />
      <param name="Reg/Force3DoF" type="string" value="true" />
      <param name="subscribe_rgbd" type="bool" value="true" />
      <param name="approx_sync" type="bool" value="false" />
      <remap from="rgbd_image" to="rgbd_image" />
    </node>
    <group if="$(eval 'ekf' in arg('odometry'))">
      <node pkg="robot_pose_ekf" type="robot_pose_ekf" name="robot_pose_ekf">
        <param name="output_frame" value="rtab/odom" />
        <param name="base_footprint_frame" value="base_link" />
        <param name="freq" value="30.0" />
        <param name="sensor_timeout" value="1.0" />
        <param name="odom_used" value="true" />
        <param name="imu_used" value="true" />
        <param name="vo_used" value="false" />

        <remap from="odom" to="transfer/odom" />
        <remap from="imu_data" to="transfer/imu" />
        <remap from="robot_pose_ekf/odom_combined" to="odom_combined" />
      </node>
      <node pkg="rtab_slam" type="ekf_transfer.py" name="ekf_transfer" output="screen" />
    </group>

    <node if="$(eval 'icp' in arg('odometry'))" pkg="rtabmap_odom" type="icp_odometry"
      name="icp_odometry">
      <remap from="scan" to="$(arg scan_topic)" />

      <param name="frame_id" type="string" value="base_link" />
      <param name="deskewing" type="string" value="true" />
      <param name="odom_frame_id" type="string" value="rtab/odom" />
      <param name="Icp/VoxelSize" type="string" value="0.05" />
      <param name="Icp/RangeMax" type="string" value="0" />
      <param name="Icp/Epsilon" type="string" value="0.001" />
      <param name="Icp/MaxTranslation" type="string" value="0" />
      <param name="Icp/PointToPlane" type="string" value="true" />
      <param name="Icp/PointToPlaneK" type="string" value="5" />
      <param name="Icp/PointToPlaneRadius" type="string" value="0.3" />
      <param name="Icp/MaxCorrespondenceDistance" type="string" value="0.1" />
      <param name="Icp/PM" type="string" value="true" />
      <param name="Icp/PMOutlierRatio" type="string" value="0.85" />
      <param name="Odom/Strategy" type="string" value="0" />
      <param name="Odom/GuessMotion" type="string" value="true" />
      <param name="Odom/ResetCountdown" type="string" value="0" />
      <param name="Odom/ScanKeyFrameThr" type="string" value="0.75" />
    </node>

    <!-- Visualization RVIZ -->
    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_cfg)" />
  </group>
</launch>